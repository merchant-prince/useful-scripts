FROM php:fpm

RUN apt-get update \
 && apt-get install -y libxml2-dev libmcrypt-dev \
                       libpng-dev libjpeg-dev libxslt1-dev \
                       libzip-dev libfreetype6-dev lsof cron \
 && docker-php-ext-configure gd --with-jpeg-dir=/usr/lib/x86_64-linux-gnu \
                                --with-freetype-dir=/usr/lib/x86_64-linux-gnu \
 && docker-php-ext-install bcmath gd intl mysqli opcache \
                           pdo_mysql soap xsl zip \
 && rm -rf /var/lib/apt/lists/*

RUN service cron start

RUN mv "$${PHP_INI_DIR}/php.ini-development" "$${PHP_INI_DIR}/php.ini"

RUN sed -i \
        -e "s/.*date.timezone.*/date.timezone\ =\ Indian\/Mauritius/" \
        -e "s/.*memory_limit.*/memory_limit\ =\ 2G/" \
        -e "s/.*opcache.save_comments.*/opcache.save_comments=1/" \
        "$${PHP_INI_DIR}/php.ini"

###
# Change the UID and GID of the www-data so that there are no
# permission conflicts on the files manipulated by the container
# on the host.
###

ARG USER_ID=${userId}
ARG GROUP_ID=${groupId}

RUN userdel -f www-data && \
    if getent group www-data; \
    then \
      groupdel www-data; \
    fi && \
    groupadd -g $${GROUP_ID} www-data && \
    useradd -l -u $${USER_ID} -g www-data www-data && \
    install -d -m 0755 -o www-data -g www-data /home/www-data && \
    chown --changes \
          --silent \
          --no-dereference \
          --recursive \
          --from=33:33 \
          $${USER_ID}:$${GROUP_ID} \
            /home/www-data
        
USER www-data
